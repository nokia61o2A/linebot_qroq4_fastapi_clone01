# ========== 1) Imports ==========
import os
import re
import random
import logging
import asyncio
from typing import Dict, List
from contextlib import asynccontextmanager
import time
from io import StringIO
from datetime import datetime, timedelta

# --- æ•¸æ“šè™•ç†èˆ‡çˆ¬èŸ² ---
import requests
from bs4 import BeautifulSoup
import httpx
import pandas as pd
import html5lib
import yfinance as yf

# --- FastAPI èˆ‡ LINE Bot SDK ---
from fastapi import FastAPI, APIRouter, Request, HTTPException
from fastapi.responses import JSONResponse
from fastapi.concurrency import run_in_threadpool

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import LineBotApiError, InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    QuickReply, QuickReplyButton, MessageAction,
    SourceUser, SourceGroup, SourceRoom, PostbackEvent,
    FlexSendMessage, BubbleContainer, BoxComponent,
    TextComponent, ButtonComponent
)

# --- AI ç›¸é—œ ---
from groq import AsyncGroq, Groq
import openai

# --- ã€éˆæ´»è¼‰å…¥ã€‘è¼‰å…¥è‡ªè¨‚çš„å½©ç¥¨èˆ‡è‚¡ç¥¨çˆ¬èŸ²æ¨¡çµ„ ---
try:
    from TaiwanLottery import TaiwanLotteryCrawler
    from my_commands.CaiyunfangweiCrawler import CaiyunfangweiCrawler
    LOTTERY_ENABLED = True
except ImportError:
    logging.warning("ç„¡æ³•è¼‰å…¥å½©ç¥¨æ¨¡çµ„ï¼Œå½©ç¥¨åŠŸèƒ½å°‡åœç”¨ã€‚")
    LOTTERY_ENABLED = False

try:
    from my_commands.stock.stock_price import stock_price
    from my_commands.stock.stock_news import stock_news
    from my_commands.stock.stock_value import stock_fundamental
    from my_commands.stock.stock_rate import stock_dividend
    from my_commands.stock.YahooStock import YahooStock
    STOCK_ENABLED = True
except ImportError as e:
    logging.warning(f"ç„¡æ³•è¼‰å…¥è‚¡ç¥¨æ¨¡çµ„ï¼Œè‚¡ç¥¨åŠŸèƒ½å°‡åœç”¨ã€‚éŒ¯èª¤: {e}")
    STOCK_ENABLED = False

# ========== 2) Setup ==========
logger = logging.getLogger("uvicorn.error")
logger.setLevel(logging.INFO)

# --- ç’°å¢ƒè®Šæ•¸ ---
BASE_URL = os.getenv("BASE_URL")
CHANNEL_TOKEN = os.getenv("CHANNEL_ACCESS_TOKEN")
CHANNEL_SECRET = os.getenv("CHANNEL_SECRET")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

if not all([BASE_URL, CHANNEL_TOKEN, CHANNEL_SECRET, GROQ_API_KEY]):
    raise RuntimeError("ç¼ºå°‘å¿…è¦ç’°å¢ƒè®Šæ•¸")

# --- API ç”¨æˆ¶ç«¯åˆå§‹åŒ– ---
line_bot_api = LineBotApi(CHANNEL_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)

async_groq_client = AsyncGroq(api_key=GROQ_API_KEY)
sync_groq_client = Groq(api_key=GROQ_API_KEY)
if OPENAI_API_KEY:
    openai_client = openai.OpenAI(api_key=OPENAI_API_KEY)
else:
    openai_client = None
    logger.warning("æœªè¨­å®š OPENAI_API_KEYï¼Œåˆ†æåŠŸèƒ½å°‡åƒ…ä½¿ç”¨ Groqã€‚")

GROQ_MODEL_PRIMARY = os.getenv("GROQ_MODEL_PRIMARY", "llama-3.1-70b-versatile")
GROQ_MODEL_FALLBACK = os.getenv("GROQ_MODEL_FALLBACK", "llama-3.1-8b-instant")

if LOTTERY_ENABLED:
    lottery_crawler = TaiwanLotteryCrawler()
    caiyunfangwei_crawler = CaiyunfangweiCrawler()

# --- ç‹€æ…‹å­—å…¸èˆ‡å¸¸æ•¸ ---
conversation_history: Dict[str, List[dict]] = {}
MAX_HISTORY_LEN = 10
user_persona: Dict[str, str] = {}
translation_states: Dict[str, str] = {}
auto_reply_status: Dict[str, bool] = {}

PERSONAS = {
    "sweet": {"title": "ç”œç¾å¥³å‹", "style": "æº«æŸ”é«”è²¼ï¼Œé¼“å‹µå®‰æ…°", "greetings": "è¦ªæ„›çš„ï½æˆ‘åœ¨é€™è£¡è½ä½ èªª ğŸŒ¸", "emoji":"ğŸŒ¸ğŸ’•ğŸ˜Š"},
    "salty": {"title": "å‚²å¬Œå¥³å‹", "style": "æ©Ÿæ™ºåæ§½ï¼Œå£å£ä½†æœ‰æº«åº¦", "greetings": "ä½ åˆä¾†å•¦ï¼Ÿèªªå§ï¼Œå“ªè£¡å¡ä½äº†ã€‚ğŸ˜", "emoji":"ğŸ˜ğŸ™„"},
    "moe":   {"title": "èŒç³»å¥³å‹", "style": "å‹•æ¼«èªæ°£ï¼‹å¯æ„›é¡æ–‡å­—", "greetings": "å‘€å‘¼ï½ä»Šå¤©ä¹Ÿè¢«æˆ‘æ²»ç™’ä¸€ä¸‹å—ï¼Ÿ(ï¾‰>Ï‰<)ï¾‰", "emoji":"âœ¨ğŸ€"},
    "cool":  {"title": "é…·ç³»å¾¡å§", "style": "å†·éœç²¾ç…‰ï¼Œé—œéµå»ºè­°", "greetings": "æˆ‘åœ¨ã€‚èªªé‡é»ã€‚", "emoji":"ğŸ§Šâš¡ï¸"}
}
LANGUAGE_MAP = { "è‹±æ–‡": "English", "æ—¥æ–‡": "Japanese", "éŸ“æ–‡": "Korean", "è¶Šå—æ–‡": "Vietnamese", "ç¹é«”ä¸­æ–‡": "Traditional Chinese"}

# ========== 3) FastAPI ==========
@asynccontextmanager
async def lifespan(app: FastAPI):
    try:
        async with httpx.AsyncClient() as c:
            headers = {"Authorization": f"Bearer {CHANNEL_TOKEN}", "Content-Type": "application/json"}
            payload = {"endpoint": f"{BASE_URL}/callback"}
            r = await c.put("https://api.line.me/v2/bot/channel/webhook/endpoint", headers=headers, json=payload, timeout=10.0)
            r.raise_for_status()
            logger.info(f"âœ… Webhook æ›´æ–°æˆåŠŸ: {r.status_code}")
    except Exception as e:
        logger.error(f"Webhook æ›´æ–°å¤±æ•—: {e}", exc_info=True)
    yield

app = FastAPI(lifespan=lifespan, title="LINE Bot", version="1.0.0")
router = APIRouter()

# ========== 4) Helpers ==========
def get_chat_id(event: MessageEvent) -> str:
    if isinstance(event.source, SourceGroup): return event.source.group_id
    if isinstance(event.source, SourceRoom):  return event.source.room_id
    return event.source.user_id

# --- AI & åˆ†æç›¸é—œå‡½å¼ ---
def get_analysis_reply(messages):
    try:
        if not openai_client: raise Exception("OpenAI client not initialized.")
        response = openai_client.chat.completions.create(model="gpt-3.5-turbo", messages=messages)
        return response.choices[0].message.content
    except Exception as openai_err:
        logger.warning(f"OpenAI API å¤±æ•—: {openai_err}")
        try:
            response = sync_groq_client.chat.completions.create(model=GROQ_MODEL_PRIMARY, messages=messages, max_tokens=2000, temperature=0.8)
            return response.choices[0].message.content
        except Exception as groq_err:
            logger.warning(f"Groq ä¸»è¦æ¨¡å‹å¤±æ•—: {groq_err}")
            try:
                response = sync_groq_client.chat.completions.create(model=GROQ_MODEL_FALLBACK, messages=messages, max_tokens=1500, temperature=1.0)
                return response.choices[0].message.content
            except Exception as fallback_err:
                logger.error(f"æ‰€æœ‰ AI API éƒ½å¤±æ•—: {fallback_err}")
                return "æŠ±æ­‰ï¼ŒAIåˆ†æå¸«ç›®å‰é€£ç·šä¸ç©©å®šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"

async def groq_chat_async(messages, max_tokens=600, temperature=0.7):
    try:
        resp = await async_groq_client.chat.completions.create(model="llama-3.1-8b-instant", messages=messages, max_tokens=max_tokens, temperature=temperature)
        return resp.choices[0].message.content.strip()
    except Exception as e:
        logger.error(f"Groq Async ä¸»è¦æ¨¡å‹å¤±æ•—: {e}")
        resp = await async_groq_client.chat.completions.create(model=GROQ_MODEL_FALLBACK, messages=messages, max_tokens=max_tokens, temperature=temperature)
        return resp.choices[0].message.content.strip()

# --- é‡‘è & å½©ç¥¨åˆ†æ ---
def get_gold_analysis():
    logger.info("é–‹å§‹åŸ·è¡Œé»ƒé‡‘åƒ¹æ ¼åˆ†æ...")
    try:
        url = "https://rate.bot.com.tw/gold?Lang=zh-TW"
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36'}
        response =

